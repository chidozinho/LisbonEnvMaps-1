from flask import Flask, request, jsonify
#from flask_sqlalchemy import SQLAlchemy
import etl as e
import os
from retriving_data import querydata
import psycopg2



# Create a flask application
app = Flask(__name__)

db_config = e.read_config("./config/00.yml")

# Set the database connection URI in the app configuration

username = db_config['database']['username']
password = db_config['database']['password']
host = db_config['database']['host']
port = db_config['database']['port']
database = db_config['database']['database']



conn = psycopg2.connect(f"dbname='{database}' user='{username}' host='{host}' password='{password}'")


app.config['SQLALCHEMY_DATABASE_URI'] = conn

# Create object to control SQLAlchemy from the Flask app
#db = SQLAlchemy(app)


# GET method to get all values from the env_variables table
@app.route('/values', methods=['GET'])
def get_all_values():
    
    try:
        cur = conn.cursor()
        cur.execute("""SELECT * from us.env_variables""")
        rows = cur.fetchall()
        print(rows)
        return jsonify(rows)
    except Exception as e:
        return []


# GET method to get all values from specific sensor
@app.route('/values/id_sensor=<id_sensor>', methods=['GET'])
def get_sensor_values(id_sensor:str):
    
    try:
        cur = conn.cursor()
        cur.execute("""SELECT * from us.env_variables where id_sensor= %s""",[id_sensor])
        rows = cur.fetchall()
        print(rows)
        return jsonify(rows)
    except Exception as e:
        return []
  
if __name__ == '__main__':
    
    app.run(debug=True)
    #app.run()